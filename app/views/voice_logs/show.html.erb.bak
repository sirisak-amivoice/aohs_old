<% content_for :header do %>
<%= javascript_src_path '/jquery/jquery-ui-1.7.2/development-bundle/ui/ui.slider.js' %>
<%#= javascript_src_path '/jquery/jquery-ui-1.8.6.custom/development-bundle/ui/jquery.ui.slider.js' %>
<%= javascript_src_path '/jquery/jquery.selectToUISlider/js/selectToUISlider.jQuery.js' %>
<%= stylesheet_src_path '/jquery/jquery.selectToUISlider/css/ui.slider.extras.css' %>
<%= javascript_src_path('/jquery/jquery.autocomplete/jquery.autocomplete.js') %>
<%= stylesheet_src_path('/jquery/jquery.autocomplete/jquery.autocomplete.css') %>
<<<<<<< .mine
<style>
.input_button { font-weight:bold; padding-left:8px; padding-right:8px; padding-top:2px; padding-bottom:2px;}
.img_act {
cursor:hand;
}
#body {
background-color:#EEEEEE;
}
.tab-default {
cursor: hand;
}
.btnPlayer {
font-weight:bold;
border:2px; solid #CCCCCC;
padding:2px;
}
.ui-slider {
	background: #e9f4ff;
	border:1px;
}
.ui-slider .ui-slider-handle {
	border:2px;
	border-color:#93B2CC;
}
=======

<style type="text/css">

  .ui-slider {
    height:6px;
    background: #e9f4ff;
  }

  .ui-slider .ui-slider-handle {
    border:1px;
    border-color:#93B2CC;
  }

  html {
    overflow: hidden;
  }

</style>

<style type="text/css">

  tr.trn { background-color: #FFE0ED; }
  tr.trm { background-color: #CCFFB2; }
  tr.trcall_information { background-color: #FFFFCE; }
  tr.trbookmark { background-color: #FAFFFF; }

  .td-voicedetail {
    width: 210px;
    background-image:url(<%=image_path('bg010.png')%>);
    color:white;
    font-weight:bold;
    padding: 2px 0px 2px 3px;
  }
  .td-voice {
    background-image:url(<%=image_path('bg012.png')%>);
  }
  .td-voice span{
    padding-left: 8px;
  }
  td.row-no { background-image: url(<%=image_path('bg002.png')%>); }
  input.btn {
    width: 57px;
    height: 25px;
    font-weight: bold;
  }

  img.act_btn { cursor: pointer; }
  div#Header {
    position: relative;
    padding: 1px 1px 0px 1px;
    width: 99.9%;
    height: 99.7%;
  }
  div.block {
    clear: both;
    float: left;
    width: 99.8%;
    padding-top: 0px;
  }
  span.agent-name {color: #0066cc; font-weight: bold;}
  span.tel-num {font-size: 12px;}
  span.tag-span{
    clear: both;
    float: left;
    margin-left: 10px;
    padding-left: 5px;
    width: 93%;
    height: 30px;
    font-size: smaller;
    word-wrap: break-word;
    overflow: hidden;
  }
  div.speaker-info {
    clear: both;
    float: left;
    width: 100%;
  }
  div#speaker-panel{
    clear:both;
    float:left;
    width: 210px;
    background: no-repeat;
    background-position: 90px 30px;
  }
  .tabs li {
    cursor: pointer;
    list-style: none;
  }
  .tabs li.detail-tabs {
    float: left;
    border-width: 1px;
    border-style: solid solid none none;
    border-color: #99ccff;
    padding: 6px 12px 3px 12px;
    margin: 0;
    font-weight: bold;
    color: #384970;
  }
  .tabs li.hover{
    color: white;
    background-color: #0070b2;
  }
  .tabs li.selected{
    background-image: url(<%=image_path('bg002.png')%>);
    color: #000000;
  }
  td.taggroup {
    font-weight: bold;
  }
  th.header-info-col {
    background-image: url(<%=image_path('bg002.png')%>);
    border:1px solid #99ccff;
    padding: 2px 2px 2px 2px;
  }
  td.info-col, td.info-col-lst {
    border:1px #99ccff;
    border-style: none solid solid none;
    padding: 2px 2px 2px 2px;
    line-height: 17px;
  }
  input.for_edit {
    background: none;
    border: 0;
  }

  input.editting { background-color: #FFFFEB; }
  span.footer_txt { font-weight: normal; font-style: italic; display: none;}

>>>>>>> .r2647
</style>

<script type="text/javascript">

  var current_pane = 1;
  var current_index = 0;

  $(document).ready(function(){

    AmiAdvw.SetSegmentGuideRange(-20,-80);
    AmiAdvw.setProperty("DisableContextMenu",1);

    jQuery.event.add(window, "load", ResizeWrapInfo);
    jQuery.event.add(window, "resize", ResizeWrapInfo);
    $('#AmiAdvw').css("height", $('#speaker-panel').height()); //$('#speaker-panel').height()
    $('#advw-vol').slider({min:0 ,max:100, step:1, value:10,
                           slide: function(event, ui){
                             AmiAdvw.PlayingVolume = (ui.value/10);
                           }});
    $('#advw-speed').slider({min:4 ,max:24, step:1, value:10,
                             slide: function(event, ui){
                               AmiAdvw.PlayingSpeed = (ui.value/10);
                             }});
    initialVoiceLog();
   
  });

  function ResizeWrapInfo(){

    var window_height = $(window).height();
    var header_height = $('#Header').height();
    var footer_height = $('#Footer').height();

    var info_header_height = $(".Info-Header-"+current_pane).height();
    var info_header_width = $(".Info-Header-"+current_pane).width();
    var WrapInfo_height = (window_height - (header_height + info_header_height + footer_height));

    $('.Info').css("height",WrapInfo_height);
    $('.tbl-info').css("width", info_header_width - 19);
  }

</script>

<script type="text/javascript">
  /* keyword list :: { type, start_time, end_time, show -> keyword.name, keyword_type, keyword_id, keyword_group_id, keyword_group_name, from} */
  var keyword_list;
  /* keyword del :: {id, from} */
  var keyword_del;
  /* call information list :: { type, start_time, end_time, show } */
  var callinfo_list;
  /* bookmark list :: { type, start_time, end_time, show, title, body, id } */
  var bookmark_list;
  /* tag list :: { tag_group_name, tag_id, tag_name } */
  var tag_list;

  var keyword_pattern = [ <%= (@keyword_pattern.to_a.map { |k| "{id: '#{k.id}', name: '#{k.name}',type: '#{k.keyword_type}',group_id: #{k.group_id},group_name:'#{k.group_name}'}"}).join(',') %> ];
  var keyword_source = ["result_keywords", "edit_keywords"];
  var voicelog_start_msec;

  function initialVoiceLog(){

    keyword_list = new Array();
    keyword_del = new Array();
    callinfo_list = new Array();
    bookmark_list = new Array();
    voicelog_start_msec = new Date (new Date().toDateString()+" <%=@voice_log.start_time.strftime("%H:%M:%S")%>").getTime();

    AmiAdvw.LoadFromFile("<%=  @voice_log.voice_file_url %>");

    <%if @voice_log.call_direction == 'i'%>
      $("#speaker-panel").css("background-image","url(<%=image_path('direct_up.png')%>)");
    <%elsif @voice_log.call_direction == 'o'%>
      $("#speaker-panel").css("background-image","url(<%=image_path('direct_down.png')%>)");
    <%end%>

    refreshTag();
    LoadEditKeyword();
    LoadCallInformation();
    LoadCallBookmark();
    updateAllView();

    <% if params[:tab] == "2" %>
        show_tab(2);
    <% elsif params[:tab] == "4" %>
        show_tab(4);
    <% else %>
        show_tab(1);
    <% end %>

    $(".detail-tabs").hover(
      function(){ // on mouseover
        $(this).addClass("hover");
      },
      function(){ // on mouseout
        $(this).removeClass("hover");
      });
  }

  function show_tab(tab_order){

    var tabs = ["All", "Keywords", "CallInformations", "BookMarks"];
    var selected_tab = tab_order-1;

    var pane = $("div.tab-pane-info");
    for(i=0; i<pane.length; i++){

      if(pane[i].id == tabs[selected_tab]){
        $("div.tab-pane-info#"+tabs[selected_tab]).css("display", "block");
        $("#selected-tab-"+tab_order).addClass("selected");
        $("#footer-span-"+tab_order).css("display","block");

        showAmiViewer(tab_order);
        current_pane = tab_order;
      }else{
        $("div.tab-pane-info#"+pane[i].id).css("display", "none");

        var cur_tab_order = (i+1);
        $("#selected-tab-"+cur_tab_order).removeClass("selected");
        $("#footer-span-"+cur_tab_order).css("display","none");
      }
    }
  }/* end function : show_tab */
  
  function buildKeywordPattern(){
    $('.kw_pattern').autocomplete(keyword_pattern,{
      minChars: 0,
      autoFill: true,
      scroll: true,
      scrollHeight: 100,
      formatItem: function(item) {
        return item.name;
      }
    }).result(function(event, data, formatted) {
      if (data) {
        keyword_list[current_index].show = data.name;
        keyword_list[current_index].keyword_type = data.type;
        keyword_list[current_index].keyword_id = data.id;
        keyword_list[current_index].keyword_group_id = data.group_id;
        keyword_list[current_index].keyword_group_name = data.group_name;
        updateKeywordView();
        showAmiViewer(current_pane);
        focusSegment(current_index, 0);
      }
    });

  }
   
  function setChannel(){

    var agent_chn = $('#agent-chn').attr("checked");
    var cust_chn = $('#cust-chn').attr("checked");

    if(agent_chn && cust_chn){
      AmiAdvw.PlayingVolumeBalance = 0.0;
    }else if(agent_chn){
      AmiAdvw.PlayingVolumeBalance = -1.0;
    }else if(cust_chn){
      AmiAdvw.PlayingVolumeBalance = 1.0;
    }else{
      switch(AmiAdvw.PlayingVolumeBalance){
        case -1: $('#agent-chn').attr("checked","checked"); break;
        case 1: $('#cust-chn').attr("checked","checked"); break;
      }
      alert("Please select at least one channel.");
    }
  }

  function showAmiViewer(tab){
    var drawSegment="";

    switch(tab){
      case 1:
        $("#action_div").css("display","none");
        var allinfo = new Array();
        allinfo = allinfo.concat(keyword_list, callinfo_list, bookmark_list);
        allinfo.sort(sortByStartTime);

        for(var index in allinfo)
          drawSegment += ((allinfo[index].start_time)+" "+(allinfo[index].end_time)+"\n");

        AmiAdvw.LoadFromSegmentFileData(drawSegment, 0);
        for(var index in allinfo)
          AmiAdvw.SetSegmentInfo(index, (allinfo[index].start_time), (allinfo[index].end_time), allinfo[index].show, 0);

        updateAllView();
      break;

      case 2:
        $("#action_div").css("display","block");
        $("#add_seg_btn").attr("value","Add Keyword");
        $("#save_change_btn").attr("value","Save Keyword");
        for(var index in keyword_list)
          drawSegment += ((keyword_list[index].start_time)+" "+(keyword_list[index].end_time)+"\n");

        AmiAdvw.LoadFromSegmentFileData(drawSegment, 0);
        for(var index in keyword_list)
          AmiAdvw.SetSegmentInfo(index, (keyword_list[index].start_time), (keyword_list[index].end_time), keyword_list[index].show, 0);

      break;

      case 3:
        $("#action_div").css("display","none");
        for(var index in callinfo_list)
          drawSegment += ((callinfo_list[index].start_time)+" "+(callinfo_list[index].end_time)+"\n");

        AmiAdvw.LoadFromSegmentFileData(drawSegment, 0);
        for(var index in callinfo_list)
          AmiAdvw.SetSegmentInfo(index, (callinfo_list[index].start_time), (callinfo_list[index].end_time), callinfo_list[index].show, 0);
      break;

      case 4:
        $("#action_div").css("display","block");
        $("#add_seg_btn").attr("value","Add Bookmark");
        $("#save_change_btn").attr("value","Save Bookmark");
        for(var index in bookmark_list)
          drawSegment += ((bookmark_list[index].start_time)+" "+(bookmark_list[index].end_time)+"\n");

        AmiAdvw.LoadFromSegmentFileData(drawSegment, 0);
        for(var index in bookmark_list)
          AmiAdvw.SetSegmentInfo(index, (bookmark_list[index].start_time), (bookmark_list[index].end_time), bookmark_list[index].body, 0);
      break;
    }
    AmiAdvw.SetSelectedRange(0,0);
  }

  /* use for sort allinfo array by start time */
  function sortByStartTime(a, b){ return a.start_time - b.start_time; }

  function canAddSegmentInfo() {

    var offsetFrom = AmiAdvw.SelectedOffsetFrom;
    var offsetTo = AmiAdvw.SelectedOffsetTo;
    if(offsetFrom != offsetTo){
      $("#add_seg_btn").attr("disabled","");
    }else{
      $("#add_seg_btn").attr("disabled","disabled");
    }
  }

  function displayKeywordType(keyword_type){
    switch(keyword_type){
      case "m": return "Must";
      case "n": return "NG";
      default : return "Undefined";
    }
  }

  function focusSegment(index, row){
    AmiAdvw.SetFocus(index, row);
    if($("#auto-play").attr("checked"))
      AmiAdvw.Play();
  }

  function PausePlay(){
    var btn = $("#play_btn");
    if(btn.val() == "Play"){
      AmiAdvw.Play();
      btn.attr("value", "Pause");
    }else if(btn.val() == "Pause"){
      AmiAdvw.PausePlaying();
      btn.attr("value", "Resume");
    }else if(btn.val() == "Resume"){
      AmiAdvw.ResumePlaying();
      btn.attr("value", "Pause");
    }
  }

  function Stop(){
    AmiAdvw.StopPlaying();
    $("#play_btn").attr("value","Play");
  }

  function movefocus(val){
    AmiAdvw.MoveFocus(val);
    if($("#auto-play").attr("checked"))
      AmiAdvw.Play();
  }

</script>

<script type="text/javascript">

  function LoadEditKeyword(){

    <% edit_keywords = @voice_log.get_result_keywords %>
    <% unless edit_keywords.empty? %>
      <% edit_keywords.each_with_index do |resultKeyword, index| %>
        keyword_list.push({type: "keyword",
                           start_time: "<%=  resultKeyword.start_sec %>",
                           end_time: "<%= resultKeyword.end_sec %>",
                           show: "<%= resultKeyword.keyword_name %>",
                           keyword_type: "<%= resultKeyword.keyword_type %>",
                           keyword_id: "<%= resultKeyword.keyword_id %>",
                           keyword_group_id: "<%= resultKeyword.keyword_group_id %>",
                           keyword_group_name: "<%= resultKeyword.keyword_group_name %>",
                           edit_status: "<%= resultKeyword.edit_status %>",
                           from: keyword_source[0],
                           id:"<%= resultKeyword.id %>"});
      <% end %>
    <% end %>

    <% edit_keywords = @voice_log.get_edit_keywords %>
    <% unless edit_keywords.empty? %>
      <% edit_keywords.each_with_index do |editKeyword, index| %>
        keyword_list.push({type: "keyword",
                           start_time: "<%=  editKeyword.start_sec %>",
                           end_time: "<%= editKeyword.end_sec %>",
                           show: "<%= editKeyword.keyword_name %>",
                           keyword_type: "<%= editKeyword.keyword_type %>",
                           keyword_id: "<%= editKeyword.keyword_id %>",
                           keyword_group_id: "<%= editKeyword.keyword_group_id %>",
                           keyword_group_name: "<%= editKeyword.keyword_group_name %>",
                           edit_status: "<%= editKeyword.edit_status %>",
                           from: keyword_source[1],
                           id:"<%= editKeyword.id %>"});
      <% end %>
    <% end %>
    updateKeywordView();
  }

  function updateKeywordView(){

    var view = "";

    keyword_list.sort(sortByStartTime);
    for(var index in keyword_list){

      var start = new Date(voicelog_start_msec + toMsec(keyword_list[index].start_time)).strftime("%H:%M:%S");
      var end = new Date(voicelog_start_msec + toMsec(keyword_list[index].end_time)).strftime("%H:%M:%S");

      view += "<tr class=\"tr"+keyword_list[index].keyword_type+"\" onclick=\"focusSegment("+index+", 0)\">";
      view += "<td class=\"info-col row-no\" width=\"40px;\">"+(parseInt(index)+1)+"</td>";
      view += "<td class=\"info-col\" width=\"140px;\">keyword</td>";
      view += "<td class=\"info-col\" width=\"100px;\" id=\"kst_"+index+"\">"+start+"</td>";
      view += "<td class=\"info-col\" width=\"100px;\" id=\"ken_"+index+"\">"+end+"</td>";
      view += "<td class=\"info-col\" width=\"60px;\">"+displayKeywordType(keyword_list[index].keyword_type)+"</td>";
      view += "<td class=\"info-col\" width=\"200px\">"+keyword_list[index].keyword_group_name+"</td>";
      view += "<td class=\"info-col\" ><input readonly id=\"kw_pattern_"+index+"\" class=\"for_edit kw_pattern\" style=\"width:100%\" value=\""+keyword_list[index].show+"\" ondblclick=\"inputEdit('kw_pattern_"+index+"', "+index+")\" onblur=\"editFinish('kw_pattern_"+index+"', "+index+")\" /></td>";
      view += "<td class=\"info-col\" width=\"40px;\" align=\"center\" >";
      <% if permission_by_name('callskeyw-upd') %>
        view += "<img src=\"<%=image_path('delete.png')%>\" name=\"delete\" class=\"act_btn\" onclick=\"deleteElement("+index+")\"/>";
      <% end %>
      view += "</td>";
      view += "</tr>";
    }

    $('#span-sum-keyword').text(keyword_list.length);
    $('#keyword_info_tbl').html(view);

    buildKeywordPattern();
  }

  function LoadCallInformation(){
    <% call_info = @voice_log.call_informations %>
    <% unless call_info.empty? %>
      <% call_info.each_with_index do |callinfo, index| %>
        callinfo_list.push({type: "call_information", start_time: "<%= callinfo.start_sec %>", end_time: "<%= callinfo.end_sec %>", show: "<%= callinfo.event %>"});
      <% end %>
    <% end %>
    updateInformationView()
  }

  function updateInformationView() {
    var view = "";

    callinfo_list.sort(sortByStartTime);
    for(var index in callinfo_list){

      var start = new Date(voicelog_start_msec + toMsec(callinfo_list[index].start_time)).strftime("%H:%M:%S");
      var end = new Date(voicelog_start_msec + toMsec(callinfo_list[index].end_time)).strftime("%H:%M:%S");

      view += "<tr class=\"trcall_information\" onclick=\"focusSegment("+index+", 0)\">";
      view += "<td class=\"info-col row-no\" width=\"40px;\">"+(parseInt(index)+1)+"</td>";
      view += "<td class=\"info-col\" width=\"140px;\">call information</td>";
      view += "<td class=\"info-col\" width=\"100px;\">"+start+"</td>";
      view += "<td class=\"info-col\" width=\"100px;\">"+end+"</td>";
      view += "<td class=\"info-col\">"+callinfo_list[index].show+"</td>";
      view += "<tr>";
    }
    $('#call_info_tbl').html(view);
  }

  function LoadCallBookmark(){

    <% call_bookmark = @voice_log.bookmarks %>
    <% unless call_bookmark.empty? %>
      <% call_bookmark.each_with_index do |callbookmark, index| %>
        bookmark_list.push({type: "bookmark", start_time: "<%= callbookmark.start_sec %>", end_time: "<%= callbookmark.end_sec %>", show: "<%= callbookmark.title %> : <%= callbookmark.body %>", title: "<%= callbookmark.title %>", body: "<%= callbookmark.body %>"});
      <% end %>
    <% end %>
    updateBookmarkView();
  }

  function updateBookmarkView() {
    var view = "";

    bookmark_list.sort(sortByStartTime);
    for(var index in bookmark_list){

      var start = new Date(voicelog_start_msec + toMsec(bookmark_list[index].start_time)).strftime("%H:%M:%S");
      var end = new Date(voicelog_start_msec + toMsec(bookmark_list[index].end_time)).strftime("%H:%M:%S");

      view += "<tr class=\"trbookmark\" onclick=\"focusSegment("+index+", 0)\">";
      view += "<td class=\"info-col row-no\" width=\"40px;\">"+(parseInt(index)+1)+"</td>";
      view += "<td class=\"info-col\" width=\"140px;\">bookmark</td>";
      view += "<td class=\"info-col\" width=\"100px;\" id=\"bst_"+index+"\">"+start+"</td>";
      view += "<td class=\"info-col\" width=\"100px;\" id=\"ben_"+index+"\">"+end+"</td>";
      view += "<td class=\"info-col\" width=\"250px;\">";
      view += "  <input readonly part=\"title\" id=\"bk_title_"+index+"\" class=\"for_edit\" style=\"width: 250px;\" value=\""+bookmark_list[index].title+"\" maxlength=\"300\" ondblclick=\"inputEdit('bk_title_"+index+"', "+index+")\" onblur=\"editFinish('bk_title_"+index+"', "+index+")\"/>";
      view += "</td>";
      view += "<td class=\"info-col\">";
      view += "  <input readonly part=\"body\" id=\"bk_body_"+index+"\" class=\"for_edit\" style=\"width:100%\" value=\""+bookmark_list[index].body+"\" maxlength=\"300\" ondblclick=\"inputEdit('bk_body_"+index+"', "+index+")\" onkeyup=\"updateTxtChange('bk_body_"+index+"', "+index+")\" onblur=\"editFinish('bk_body_"+index+"', "+index+")\" />"
      view += "</td>";
      view += "<td class=\"info-col\" width=\"40px;\" align=\"center\" >";
      <% if permission_by_name('bookmarks-upd') %>
        view += "<img src=\"<%=image_path('delete.png')%>\" class=\"act_btn\" name=\"delete\" onclick=\"deleteElement("+index+")\" />";
      <% end %>
      view += "</td>";
      view += "<tr>";
    }
    $('#span-sum-bookmark').text(bookmark_list.length);
    $('#bookmark_info_tbl').html(view);
  }

  function updateAllView(){

    var view = "";
    var allinfo = new Array();

    allinfo = allinfo.concat(keyword_list, callinfo_list, bookmark_list);
    allinfo.sort(sortByStartTime);

    $('#all_info_tbl').html(view);
    for(var index in allinfo){

      var start = new Date(voicelog_start_msec + toMsec(allinfo[index].start_time)).strftime("%H:%M:%S");
      var end = new Date(voicelog_start_msec + toMsec(allinfo[index].end_time)).strftime("%H:%M:%S");

      if(null != allinfo[index].keyword_type){
        view += "<tr class=\"tr"+allinfo[index].keyword_type+"\" onclick=\"focusSegment("+index+", 0)\">";
      }else{
        view += "<tr class=\"tr"+allinfo[index].type+"\" onclick=\"focusSegment("+index+", 0)\">";
      }

      view += "<td class=\"info-col row-no\" width=\"40px;\">"+(parseInt(index)+1)+"</td>";
      view += "<td class=\"info-col\" width=\"140px;\">"+allinfo[index].type.replace(/_/g," ")+"</td>";
      view += "<td class=\"info-col\" width=\"100px;\">"+start+"</td>";
      view += "<td class=\"info-col\" width=\"100px;\">"+end+"</td>";
      view += "<td class=\"info-col\">"+allinfo[index].show+"</td>";
      view += "</tr>";
    }
    $('#all_info_tbl').html(view);
  }

  function toMsec(time){ return time*1000 }

  function addSegmentInfo(){
    AmiAdvw.AddSegmentInfo();
    /*
     * see 'AttributeChanged' on 'create' event.
     */
  }

  function addElement(pane){
    var row_focus = AmiAdvw.GetFocus(0);
    var seg_info = AmiAdvw.GetSegmentInfo(row_focus, 0.0, 0.0, "", 0);

    var start = seg_info.split(/ /)[0];
    var end = seg_info.split(/ /)[1];

    switch(pane){
      case 2:
        keyword_list.push({type: "keyword", start_time: start, end_time: end, show: "", keyword_type: "", keyword_id: "", keyword_group_id: "",keyword_group_name: "",from: keyword_source[1], id: "-1"});
        updateKeywordView();
      break;
      case 4:
        bookmark_list.push({type: "bookmark", start_time: start, end_time: end, show: "", title: "", body: ""});
        updateBookmarkView();
      break;
    }
  }

  function deleteElement(index) {

    if(confirm("Delete keyword?")){
      switch(current_pane){
        case 2:
          if(keyword_list[index].id != "-1")    /* ID: `-1` >> new element */
            keyword_del.push({id: keyword_list[index].id, from: keyword_list[index].from});

          keyword_list.splice(index, 1);
          updateKeywordView();
          showAmiViewer(current_pane);
        break;
        case 4:
          bookmark_list.splice(index, 1);
          updateBookmarkView();
          showAmiViewer(current_pane);
        break;
      }
    }

  }

  function inputEdit(element_id, index) {
    $("#"+element_id).removeAttr("readonly");
    $("#"+element_id).addClass("editting");
    $("#"+element_id).focus();
    current_index = index;
  }

  function updateTxtChange(element_id, index) {
    AmiAdvw.SetSegmentInfo(index,bookmark_list[index].start_time, bookmark_list[index].end_time,$("#"+element_id).val(),0);
  }

  function editFinish(element_id, index) {
    $("#"+element_id).attr("readonly", true);
    $("#"+element_id).removeClass("editting");

    var work_part = $("#"+element_id).attr("part");

    if(current_pane == 4){
      if("title"==work_part){
        bookmark_list[index].title = $("#"+element_id).val();
      }else if("body"==work_part){
        bookmark_list[index].body = $("#"+element_id).val();
      }
      bookmark_list[index].show = bookmark_list[index].title+" : "+bookmark_list[index].body;
    }
  }

  function saveChangeInfo(){
    $('#save_change_btn').attr("disabled","disabled");
    switch(current_pane){
      case 2:
        if(confirm("Save keyword?")){

          var edit_k = new Array();
          var edit_d = new Array();
          var result_k = new Array();
          var result_d = new Array();

          for(var index in keyword_list){
            if(keyword_list[index].from == keyword_source[0]){
              result_k.push(new Array(keyword_list[index].start_time, keyword_list[index].end_time, keyword_list[index].keyword_id, keyword_list[index].id));
            }else{
              edit_k.push(new Array(keyword_list[index].start_time, keyword_list[index].end_time, keyword_list[index].keyword_id, keyword_list[index].id));
            }
          }
          for(var index in keyword_del){
            if(keyword_del[index].from == keyword_source[0]){
              result_d.push(new Array(keyword_del[index].id));
            }else{
              edit_d.push(new Array(keyword_del[index].id));
            }
          }
          $.post("<%= url_for(:controller => 'keywords', :action => 'save_change_keyword') %>",
                {'voice_log_id': "<%= @voice_log.id %>",
                 'edit_keywords[]':edit_k,
                 'edit_del[]':edit_d,
                 'result_keywords[]':result_k,
                 'result_del[]':result_d},
                 function(data){
                   alert(data);
                   window.location.href = "<%=url_for :controller=>'voice_logs',:action => 'show', :id => params[:id], :tab => 2 %>";
                 });
        }
      break;

      case 4:
        if(confirm("Save bookmark?")){
          var bookmark = new Array();
          for(var index in bookmark_list){
            bookmark.push(new Array(bookmark_list[index].start_time, bookmark_list[index].end_time, bookmark_list[index].title, bookmark_list[index].body));
          }
          $.post("<%= url_for(:controller => 'bookmark', :action => 'save_change_bookmark') %>",{'voice_log_id': "<%= @voice_log.id %>",'bookmarks[]': bookmark},
                 function(data){
                   alert(data);
                   window.location.href = "<%=url_for :controller=>'voice_logs',:action => 'show', :id => params[:id], :tab => 4 %>";
                 });
        }
      break;
    }
    $('#save_change_btn').attr("disabled","");
  }

  function refreshTag() {
    var voice_log_id = <%= @voice_log.id %>;

    $.getJSON("<%= url_for(:controller => 'call_tags', :action=>'load_tags') %>", {voice_id: voice_log_id},function(data){
      if(data != null){

        var tag = new Array();
        var data_length = data.length;

        var index = 0, order = 1;
        while(index < data_length){
          var current_tag = data[index];
          if(current_tag.status == 'checked'){
            tag.push(current_tag.tag_name);
          }
          index++;
        }
        autoEllipsis($("#tag-span"), tag.join(", "))
      }
    });
  }

  function autoEllipsis(element, text){
    element.attr("title",text);

    var txtLength = text.length;
    if(txtLength >= 75)
      text = text.substring(0, 75)+"...";

    element.text(text);
  }

  function manageTag() {
    var voice_log_id = <%= @voice_log.id %>;

    $.getJSON("<%= url_for(:controller => 'call_tags', :action=>'load_tags') %>", {voice_id: voice_log_id},function(data){

      if(data != null){

        var data_length = data.length;
        var index = 0;
        var current_tag_group = data[index].tag_group;
        var view = "<tr><td class=\"taggroup\">"+current_tag_group+"</td></tr>\n";

        while(index < data_length){
          var current_tag = data[index];
          if(current_tag.tag_group == current_tag_group){
            view += " <tr><td><input type=\"checkbox\" class=\"tag\" value=\""+current_tag.tag_name+"\""+current_tag.status+"/>"+current_tag.tag_name+"</td></tr>\n";
          }else{
            view += "<tr><td>&nbsp;</td></tr>";
            view += "<tr><td class=\"taggroup\">"+current_tag.tag_group+"<td></tr>\n";
            view += " <tr><td><input type=\"checkbox\" class=\"tag\" value=\""+current_tag.tag_name+"\""+current_tag.status+"/>"+current_tag.tag_name+"</td></tr>\n";
            current_tag_group = current_tag.tag_group;
          }
          index++;
        }
        $("#tbl_tag").html(view);
      }
      openManageTagDialog();
    });
  }

  function openManageTagDialog(){
    $("#tag-update-span").css("display","none");
    $("#tag_manage").dialog("open");
    $("#tag_manage").dialog({
      show: 'fold',
      hide:'fold',
      bgiframe: true,
      modal: true,
      draggable: false,
      resizable: false,
      position: [60,136],
      width: 340,
      height: 280,
      buttons:{
        "cancel": function(){ $(this).dialog("close") },
        "save": function(){

          var voice_log_id = <%= @voice_log.id %>;

          var selectTag = new Array();
          var deleteTag = new Array();
          $(".tag").each(function(){
            var choose = $(this).attr("checked");
            if (choose){
              selectTag.push($(this).val());
            }else{
              deleteTag.push($(this).val());
            }
          });

          $.post("<%= url_for(:controller => 'tag', :action => 'update_tag') %>",
                 {'new_tags[]': selectTag, 'del_tags[]': deleteTag,'voice_id': voice_log_id},
                 function(data){
                   $("#tag-update-span").css("display","block");
                   setTimeout("$(\"#tag_manage\").dialog(\"close\");",350);
                   refreshTag();
                 });
        }
      }
    });
  }

  function checkOverlap(start, end, source){

    var alert_txt = "Overlap segment !!!";
    var new_start = parseFloat(start);
    var new_end = parseFloat(end);
    for(var index in source){

      var old_start = parseFloat(source[index].start_time);
      var old_end = parseFloat(source[index].end_time);

      if(((new_start >= old_start) && (new_start <= old_end)) || ((new_end >= old_start) && (new_end <= old_end))){
        alert(alert_txt);
        return true;
      }else if((new_start <= old_start) && (new_end >= old_end)){
        alert(alert_txt);
        return true;
      }
    }
    return false;
  }

  function resetVolume(){
    $("#advw-vol").slider("option","value",10);
    AmiAdvw.PlayingVolume = 1;
  }

</script>

<script type="text/javascript" for="AmiAdvw" event="AttributeChanged(target, parameter1, parameter2)">

  canAddSegmentInfo();

  var advw_event = { create: 12288, x: 524288, setSegmentInfo: 8192, click: 8};
  var cur_event = target;
  var row_focus = parameter1;
  var row_index = AmiAdvw.GetFocus(row_focus);

  /* Event :: Click some segment */
  if((row_index != -1) && (cur_event != advw_event.create) && (cur_event != advw_event.x) && (cur_event != advw_event.setSegmentInfo)){

    current_index = row_index;
    var seg_info = AmiAdvw.GetSegmentInfo(current_index, 0.0, 0.0, "", 0);

    var start = seg_info.split(/ /)[0];
    var end = seg_info.split(/ /)[1];

    var start_view = new Date(voicelog_start_msec + toMsec(start)).strftime("%H:%M:%S");
    var end_view = new Date(voicelog_start_msec + toMsec(end)).strftime("%H:%M:%S");
    switch(current_pane){
      case 2:
        keyword_list[current_index].start_time = start;
        keyword_list[current_index].end_time = end;
        $("#kst_"+current_index).text(start_view);
        $("#ken_"+current_index).text(end_view);
        break;
      case 4:
        bookmark_list[current_index].start_time = start;
        bookmark_list[current_index].end_time = end;
        $("#bst_"+current_index).text(start_view);
        $("#ben_"+current_index).text(end_view);
        break;
    }
    $("#add_seg_btn").attr("disabled","disabled");
  }

  /* Event :: Create segment */
  if((row_index != -1) && (cur_event == advw_event.create)){
    var crt_info = AmiAdvw.GetSegmentInfo(row_index, 0.0, 0.0, "", 0);

    var start_crt = crt_info.split(/ /)[0];
    var end_crt = crt_info.split(/ /)[1];
    var overlap = false;

    switch(current_pane){
      case 2: overlap = checkOverlap(start_crt, end_crt, keyword_list); break;
      case 4: overlap = checkOverlap(start_crt, end_crt, bookmark_list); break;
    }

    if(!overlap){
      $("#add_seg_btn").attr("disabled","disabled");
      addElement(current_pane);
    }else{
      AmiAdvw.RemoveSegmentInfo();
      AmiAdvw.SetSelectedRange(0,0);
    }
  }

</script>

<script type="text/javascript" for="AmiAdvw" event="PlayerStarted()"> $("#play_btn").attr("value","Pause"); $("#stop_btn").attr("disabled","");</script>
<script type="text/javascript" for="AmiAdvw" event="PlayerPaused()"> $("#play_btn").attr("value","Resume"); </script>
<script type="text/javascript" for="AmiAdvw" event="PlayerResumed()"> $("#play_btn").attr("value","Pause"); </script>
<script type="text/javascript" for="AmiAdvw" event="PlayerStopped()"> $("#play_btn").attr("value","Play"); $("#stop_btn").attr("disabled","disabled");</script>
<% end %>

<div id="tag_manage" title="Tag management" style="display: none;">
  <div style="overflow-y: scroll; overflow-x: hidden; width: 99%; height: 75%; border: 1px solid #99ccff;">
    <table border="0" cellspacing="0" cellpadding="0">
      <tbody id="tbl_tag"><tr><td>&nbsp;</td></tr></tbody>
    </table>
  </div>
  <span style="font-style: italic;">Choose call tag from this list.</span>
  <span id="tag-update-span" style="clear: both; float: right; display: none; margin: 0;">Update complete.</span>
</div>

<!-- Begin : HEADER -->
<div id="Header">
  <!-- Header detail -->
  <div style="border: 1px solid #0070b2;">
    <table width="100%" cellpadding="0" cellspacing="0" border="0">
      <tr>
        <td class="td-voicedetail"> Voice details </td>
        <td align="left" class="td-voice">
          <span><b>Start time: </b><%= @voice_log.start_time.strftime("%Y-%m-%d %H:%M:%S") %></span>
          <span><b>Duration: </b><%= format_sec(@voice_log.duration.to_i) %></span>
          <span><b>Call direction: </b><%= @voice_log.call_direction_name %></span>
        </td>
        <td align="right" class="td-voice" style="padding-right: 6px;">
          <span><b>System Id: </b><%= @voice_log.system_id %></span>
          <span><b>Device Id: </b><%= @voice_log.device_id %></span>
          <span><b>Channel Id: </b><%= @voice_log.channel_id %></span>
        </td>
      </tr>
    </table>
  </div>
  <!-- Header detail -->

  <!-- Speaker's detail & ADVW -->
  <div class="speaker-detail block">
    <div id="speaker-panel">
      <div class="speaker-info">
        <table cellspacing="5px">
          <tr>
            <td><input type="checkbox" id="agent-chn" checked onclick="setChannel();" /></td>
            <td><%= image_tag "operator.png" %></td>
            <td>
              <span class="agent-name"><%= @voice_log.user.nil? ? "Unknown Agent" : @voice_log.user.display_name%></span><br/>
              <span class="tel-num"><b>Ext: </b><%= @voice_log.extension %></span><br/>
              <span class="tel-num"><%= @voice_log.call_direction == 'i'? @voice_log.dnis : @voice_log.ani%></span>
            </td>
          </tr>
        </table>
      </div>
      <div class="speaker-info">
        <table cellspacing="5px">
          <tr>
            <td><input type="checkbox" id="cust-chn" checked onclick="setChannel();" /></td>
            <td><%= image_tag "customer.png" %></td>
            <td>
              <span class="agent-name">Customer</span><br/>
              <span class="tel-num"><%= @voice_log.call_direction == 'i'? @voice_log.ani : @voice_log.dnis%></span>
            </td>
          </tr>
        </table>
      </div>
    </div>
    <div style="clear:both; float: left; width: 210px;">
      <span style="font-weight:bold; font-size:11px; color:#0066cc; padding-left: 10px">Tags:-&nbsp;</span>
      <% if permission_by_name('favorites-upd') %>
      <span style="cursor: pointer;" onclick="manageTag();"><%= image_tag('add_tag.png',{:border => 0,:align => 'absmiddle', :alt=>"manage tag"}) %></span>
      <% end %>
      <span id="tag-span" class="tag-span"></span>
    </div>
    <div style="float: left; margin-left: 6px;">
      <div style="margin-top: 3px; border: 1px solid #848B8F;">
        <object id="AmiAdvw" classid="clsid:E95BFCD4-723A-4580-B8A6-ACADCE6DE293" width="100%" height="100px" style=" z-index: -1;"codebase="http://journey/tools/amiadvw/AmiAdvwCtrl.exe#version=1,0,27,0">
          <param name="MeasureVisible" value="1" />
          <param name="ColorTheme" value="1" />
          <param name="ScrollBarVisible" value="1" />
          <param name="ColorTheme" value="2" />
          <param name="SegmentGuideTextSizeLevel" value="2" />
          <param name="SegmentGuideVisible" value="4" />
        </object>
      </div>
      <div class="voice-start" style="float: left;"><%= @voice_log.start_time.strftime("%H:%M:%S") %></div>
      <div class="voice-end" style="float: right;"><%= (@voice_log.start_time + @voice_log.duration.to_i).strftime("%H:%M:%S") %></div>
      <div class="AmiAdvw-ctrl" style="clear: both; float: left; width:100%; padding-top: 2px;">
        <div style="float: left;">
          <input type="button" class="btn" value="Play" id="play_btn" onclick="PausePlay()"/>
          <input type="button" class="btn" value="Stop" id="stop_btn" onclick="Stop()" disabled/>
          <input type="button" class="btn" value="<<" onclick="movefocus(0)"/>
          <input type="button" class="btn" value=">>" onclick="movefocus(1)"/>
        </div>
        <div style="float: left;">
          <table>
            <tr align="left">
              <td style="padding: 3px 0px 0px 0px;"><input type="checkbox" id="auto-play"/></td>
              <td style="padding-top: 4px; font-weight: bold;">AutoPlay</td>
              <td align="right" style="width: 50px; padding-top: 4px; font-weight: bold; cursor: pointer;" title="reset volume" onclick="resetVolume();"> Volume </td>
              <td style="padding: 5px 0px 0px 7px; width: 100px;"><div id="advw-vol"></div></td>
              <!--td align="right" style="width: 50px; padding-top: 4px; font-weight: bold;"> speed </td>
              <td style="padding: 5px 0px 0px 7px; width: 100px;"><div id="advw-speed"></div></td-->
            </tr>
          </table>
        </div>
        <div id="action_div" style="float: right; display: none;">
          <table cellpadding="0" cellspacing="0">
            <tr align="left">
              <td><input type="button" class="btn" value="" onclick="addSegmentInfo()" id="add_seg_btn" style="width: 100px; margin-left: 15px;" disabled/></td>
              <td><input type="button" class="btn" value="" onclick="saveChangeInfo()" id="save_change_btn" style="width: 100px; margin-left: 3px;"/></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Speaker's detail & ADVW -->

  <!-- Tabs -->
  <div class="tabs block" style="margin-top: 8px; background-image:url(<%=image_path('bg011.png')%>); width: 100%;">
    <ul style="padding: 0; margin: 0; width: 99.9%;">
      <li id="selected-tab-1" class="detail-tabs" onclick="show_tab(1)" style="border-left: 1px solid #99ccff;"> All </li>
      <li id="selected-tab-2" class="detail-tabs" onclick="show_tab(2)"> Keywords (<span id="span-sum-keyword"></span>)</li>
      <li id="selected-tab-3" class="detail-tabs" onclick="show_tab(3)"> Call informations (<span><%= @voice_log.call_informations.length %></span>)</li>
      <li id="selected-tab-4" class="detail-tabs" onclick="show_tab(4)"> Bookmarks (<span id="span-sum-bookmark"></span>)</li>
    </ul>
  </div>
  <!-- Tabs -->
</div>
<!-- End : HEADER -->

<!-- Begin : WRAP-INFO -->
<div id="Wrap-Info" style="position: relative; clear: both; float: left; width: 99.9%; padding: 0px 1px 0px 1px; margin: 0;">

  <div id="All" class="tab-pane-info" style="position: relative; width: 100%; ">
    <table class="Info-Header-1" width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse;">
        <tr>
          <th class="header-info-col" width="40px;">No</th>
          <th class="header-info-col" width="140px;">Information Type</th>
          <th class="header-info-col" width="100px;">Start Time</th>
          <th class="header-info-col" width="100px;">End Time</th>
          <th class="header-info-col">Description</th>
          <th class="header-info-col" width="13px;"></th>
        </tr>
    </table>
    <div class="Info" style="overflow-y: scroll; overflow-x: hidden; border: 1px solid #99ccff;">
      <table id="all_info_tbl" class="tbl-info" width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse;"></table>
    </div>
  </div>

  <div id="Keywords" class="tab-pane-info" style="position: relative; width: 100%; display: none;">
    <table class="Info-Header-2" width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse;">
        <tr>
          <th class="header-info-col" width="40px;">No</th>
          <th class="header-info-col" width="140px;">Information Type</th>
          <th class="header-info-col" width="100px;">Start Time</th>
          <th class="header-info-col" width="100px;">End Time</th>
          <th class="header-info-col" width="60px;">Type</th>
          <th class="header-info-col" width="200px">Keyword</th>
          <th class="header-info-col" >Keyword Pattern</th>
          <th class="header-info-col" width="40px;">Delete</th>
          <th class="header-info-col" width="13px;"></th>
        </tr>
    </table>
    <div class="Info" style="overflow-y: scroll; overflow-x: hidden; border: 1px solid #99ccff;">
      <table id="keyword_info_tbl" class="tbl-info" width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse;"></table>
    </div>
  </div>

  <div id="CallInformations" class="tab-pane-info" style="position: relative; width: 100%; display: none;">
    <table class="Info-Header-3" width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse;">
        <tr>
          <th class="header-info-col" width="40px;">No</th>
          <th class="header-info-col" width="140px;">Information Type</th>
          <th class="header-info-col" width="100px;">Start Time</th>
          <th class="header-info-col" width="100px;">End Time</th>
          <th class="header-info-col">Description</th>
          <th class="header-info-col" width="13px;"></th>
        </tr>
    </table>
    <div class="Info" style="overflow-y: scroll; overflow-x: hidden; border: 1px solid #99ccff;">
      <table id="call_info_tbl" class="tbl-info" width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse;"></table>
    </div>
  </div>

  <div id="BookMarks" class="tab-pane-info" style="position: relative; width: 100%; display: none;">
    <table class="Info-Header-4" width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse;">
        <tr>
          <th class="header-info-col" width="40px;">No</th>
          <th class="header-info-col" width="140px;">Information Type</th>
          <th class="header-info-col" width="100px;">Start Time</th>
          <th class="header-info-col" width="100px;">End Time</th>
          <th class="header-info-col" width="250px;">Title</th>
          <th class="header-info-col">Contents</th>
          <th class="header-info-col" width="40px;">Delete</th>
          <th class="header-info-col" width="13px;"></th>
        </tr>
    </table>
    <div class="Info" style="overflow-y: scroll; overflow-x: hidden; border: 1px solid #99ccff;">
      <table id="bookmark_info_tbl" class="tbl-info" width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse;"></table>
    </div>
  </div>

</div>
<!-- End : WRAP-INFO -->

<!-- Begin : FOOTER -->
<div id="Footer" style="position: relative; clear: both; width: 100%; height: 30px; background-image:url(<%=image_path('bg002.png')%>); padding:4px 4px 4px 10px;">
  <span class="footer_txt" id="footer-span-2">Note: Double click on `Keyword Pattern` column to edit keyword.</span>
  <span class="footer_txt" id="footer-span-4">Note: Double click on `Title` and `Contents` column to edit bookmark.</span>
</div>
<!-- End : FOOTER -->