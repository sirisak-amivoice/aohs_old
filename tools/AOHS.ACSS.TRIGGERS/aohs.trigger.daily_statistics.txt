CREATE TABLE `NewTable` (
`id`  int(11) NOT NULL AUTO_INCREMENT ,
`start_day`  date NOT NULL ,
`agent_id`  int(10) NULL DEFAULT NULL ,
`keyword_id`  int(10) NULL DEFAULT NULL ,
`statistics_type_id`  int(10) NOT NULL ,
`value`  int(10) NULL DEFAULT NULL ,
`created_at`  datetime NULL DEFAULT NULL ,
`updated_at`  datetime NULL DEFAULT NULL ,
PRIMARY KEY (`id`),
INDEX `daily_index` USING BTREE (`start_day`, `agent_id`, `statistics_type_id`) ,
INDEX `daily_index2` USING BTREE (`start_day`, `keyword_id`, `statistics_type_id`) 
)
ENGINE=InnoDB
DEFAULT CHARACTER SET=utf8 COLLATE=utf8_general_ci
AUTO_INCREMENT=1
ROW_FORMAT=COMPACT
;
 
CREATE DEFINER=`mysqladmin`@`%` TRIGGER `update_weekly_and_monthly_afin` AFTER INSERT ON `NewTable`
FOR EACH ROW BEGIN
	DECLARE xtotal INT DEFAULT 0;
	DECLARE bod DATE DEFAULT NULL;
	DECLARE eod DATE DEFAULT NULL;
	DECLARE rec_id INT DEFAULT NULL;

	-- weekly 

	SET bod = beginning_of_week(new.start_day);
	SET eod = end_of_week(new.start_day);

	IF bod IS NOT NULL AND eod IS NOT NULL AND new.statistics_type_id IS NOT NULL THEN
		IF new.agent_id IS NOT NULL AND new.keyword_id IS NOT NULL THEN
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.agent_id = new.agent_id AND d.keyword_id = new.keyword_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);
		ELSEIF new.agent_id IS NULL THEN 
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.keyword_id = new.keyword_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);
		ELSE
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.agent_id = new.agent_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);		
		END IF;

		IF xtotal IS NULL THEN 
			SET xtotal = 0;
		END IF;
		
		IF new.agent_id IS NOT NULL AND new.keyword_id IS NOT NULL THEN
			SELECT id INTO rec_id FROM weekly_statistics w WHERE w.agent_id = new.agent_id AND w.keyword_id = new.keyword_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;
		ELSEIF new.agent_id IS NULL THEN 
			SELECT id INTO rec_id FROM weekly_statistics w WHERE w.keyword_id = new.keyword_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;		
		ELSE
			SELECT id INTO rec_id FROM weekly_statistics w WHERE w.agent_id = new.agent_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;		
		END IF;

		IF rec_id IS NULL THEN
			INSERT INTO weekly_statistics(start_day,agent_id,keyword_id,statistics_type_id,value,cweek,cwyear,created_at,updated_at)
			VALUES(bod,new.agent_id,new.keyword_id,new.statistics_type_id,xtotal,WEEK(bod),YEAR(bod),NOW(),NOW());
		ELSE
			UPDATE weekly_statistics SET value = xtotal, updated_at = NOW() WHERE id = rec_id LIMIT 1;
		END IF;
	END IF;

	-- monthly

	SET bod = beginning_of_month(new.start_day);
	SET eod = end_of_month(new.start_day);

	IF bod IS NOT NULL AND eod IS NOT NULL AND new.statistics_type_id IS NOT NULL THEN
		IF new.agent_id IS NOT NULL AND new.keyword_id IS NOT NULL THEN
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.agent_id = new.agent_id AND d.keyword_id = new.keyword_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);
		ELSEIF new.agent_id IS NULL THEN 
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.keyword_id = new.keyword_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);
		ELSE
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.agent_id = new.agent_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);
		END IF;

		IF xtotal IS NULL THEN 
			SET xtotal = 0;
		END IF;
		
		IF new.agent_id IS NOT NULL AND new.keyword_id IS NOT NULL THEN
			SELECT id INTO rec_id FROM monthly_statistics w WHERE w.agent_id = new.agent_id AND w.keyword_id = new.keyword_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;
		ELSEIF new.agent_id IS NULL THEN 
			SELECT id INTO rec_id FROM monthly_statistics w WHERE w.keyword_id = new.keyword_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;		
		ELSE
			SELECT id INTO rec_id FROM monthly_statistics w WHERE w.agent_id = new.agent_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;		
		END IF;

		IF rec_id IS NULL THEN
			INSERT INTO monthly_statistics(start_day,agent_id,keyword_id,statistics_type_id,value,created_at,updated_at)
			VALUES(bod,new.agent_id,new.keyword_id,new.statistics_type_id,xtotal,NOW(),NOW());
		ELSE
			UPDATE monthly_statistics SET value = xtotal WHERE id = rec_id LIMIT 1;
		END IF;	
	END IF;

END;

CREATE DEFINER=`mysqladmin`@`%` TRIGGER `update_weekly_and_monthly_afup` AFTER UPDATE ON `NewTable`
FOR EACH ROW BEGIN
	DECLARE xtotal INT DEFAULT 0;
	DECLARE xtotal2 INT DEFAULT 0;	
	DECLARE bod DATE DEFAULT NULL;
	DECLARE eod DATE DEFAULT NULL;
	DECLARE rec_id INT DEFAULT NULL;
	
	-- weekly 
		
	SET bod = beginning_of_week(new.start_day);
	SET eod = end_of_week(new.start_day);

	IF bod IS NOT NULL AND eod IS NOT NULL AND new.statistics_type_id IS NOT NULL THEN
		IF new.agent_id IS NOT NULL AND new.keyword_id IS NOT NULL THEN
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.agent_id = new.agent_id AND d.keyword_id = new.keyword_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);
		ELSEIF new.agent_id IS NULL THEN 
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.keyword_id = new.keyword_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);
		ELSE
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.agent_id = new.agent_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);		
		END IF;

		IF xtotal IS NULL THEN 
			SET xtotal = 0;
		END IF;
		
		IF new.agent_id IS NOT NULL AND new.keyword_id IS NOT NULL THEN
			SELECT id,value INTO rec_id,xtotal2 FROM weekly_statistics w WHERE w.agent_id = new.agent_id AND w.keyword_id = new.keyword_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;
		ELSEIF new.agent_id IS NULL THEN 
			SELECT id,value INTO rec_id,xtotal2 FROM weekly_statistics w WHERE w.keyword_id = new.keyword_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;		
		ELSE
			SELECT id,value INTO rec_id,xtotal2 FROM weekly_statistics w WHERE w.agent_id = new.agent_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;		
		END IF;
		IF xtotal != xtotal2 THEN		
			IF rec_id IS NULL THEN
				INSERT INTO weekly_statistics(start_day,agent_id,keyword_id,statistics_type_id,value,cweek,cwyear,created_at,updated_at)
				VALUES(bod,new.agent_id,new.keyword_id,new.statistics_type_id,xtotal,WEEK(bod),YEAR(bod),NOW(),NOW());
			ELSE
				UPDATE weekly_statistics SET value = xtotal, updated_at = NOW() WHERE id = rec_id LIMIT 1;
			END IF;
		END IF;
	END IF;

	-- monthly

	SET bod = beginning_of_month(new.start_day);
	SET eod = end_of_month(new.start_day);

	IF bod IS NOT NULL AND eod IS NOT NULL AND new.statistics_type_id IS NOT NULL THEN
		IF new.agent_id IS NOT NULL AND new.keyword_id IS NOT NULL THEN
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.agent_id = new.agent_id AND d.keyword_id = new.keyword_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);
		ELSEIF new.agent_id IS NULL THEN 
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.keyword_id = new.keyword_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);
		ELSE
			SELECT sum(d.value) as total INTO xtotal 
			FROM daily_statistics d 
			WHERE d.agent_id = new.agent_id AND d.statistics_type_id = new.statistics_type_id AND (d.start_day >= bod AND d.start_day <= eod);
		END IF;

		IF xtotal IS NULL THEN 
			SET xtotal = 0;
		END IF;
		
		IF new.agent_id IS NOT NULL AND new.keyword_id IS NOT NULL THEN
			SELECT id,value INTO rec_id,xtotal2 FROM monthly_statistics w WHERE w.agent_id = new.agent_id AND w.keyword_id = new.keyword_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;
		ELSEIF new.agent_id IS NULL THEN 
			SELECT id,value INTO rec_id,xtotal2 FROM monthly_statistics w WHERE w.keyword_id = new.keyword_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;		
		ELSE
			SELECT id,value INTO rec_id,xtotal2 FROM monthly_statistics w WHERE w.agent_id = new.agent_id AND w.statistics_type_id = new.statistics_type_id AND w.start_day = bod LIMIT 1;		
		END IF;
		IF xtotal != xtotal2 THEN
			IF rec_id IS NULL THEN
				INSERT INTO monthly_statistics(start_day,agent_id,keyword_id,statistics_type_id,value,created_at,updated_at)
				VALUES(bod,new.agent_id,new.keyword_id,new.statistics_type_id,xtotal,NOW(),NOW());
			ELSE
				UPDATE monthly_statistics SET value = xtotal WHERE id = rec_id LIMIT 1;
			END IF;	
		END IF;
	END IF;

END;

